<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Between Lines - Daily Literary Reflections</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2C2C2C">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Between Lines">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;500&family=Work+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --cream: #FAF7F2;
            --charcoal: #2C2C2C;
            --stone: #8B8680;
            --soft-black: #1A1A1A;
            --whisper: #E8E4DD;
            --accent: #9C8B7A;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Work Sans', sans-serif;
            background: var(--cream);
            color: var(--charcoal);
            line-height: 1.7;
            overflow-x: hidden;
        }

        /* Texture overlay for organic feel */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.02) 2px, rgba(0,0,0,.02) 4px);
            pointer-events: none;
            z-index: 9999;
            opacity: 0.3;
        }

        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: 0 32px;
            position: relative;
        }

        /* Login Page */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            animation: fadeIn 1.2s ease-out forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        .login-container {
            width: 100%;
            max-width: 420px;
            padding: 64px 48px;
            background: white;
            border: 1px solid var(--whisper);
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }

        .logo {
            font-family: 'Crimson Pro', serif;
            font-size: 28px;
            font-weight: 300;
            letter-spacing: 2px;
            text-align: center;
            margin-bottom: 48px;
            color: var(--soft-black);
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            color: var(--stone);
            font-weight: 400;
        }

        input {
            width: 100%;
            padding: 16px 0;
            border: none;
            border-bottom: 1px solid var(--whisper);
            background: transparent;
            font-family: 'Work Sans', sans-serif;
            font-size: 16px;
            color: var(--charcoal);
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-bottom-color: var(--accent);
        }

        input::placeholder {
            color: var(--stone);
            opacity: 0.5;
        }

        .btn {
            width: 100%;
            padding: 18px;
            margin-top: 32px;
            border: 1px solid var(--charcoal);
            background: var(--soft-black);
            color: var(--cream);
            font-family: 'Work Sans', sans-serif;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 400;
        }

        .btn:hover {
            background: var(--charcoal);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Main App Page */
        .app-page {
            display: none;
            min-height: 100vh;
            padding: 80px 0 120px;
        }

        .app-page.active {
            display: block;
            animation: slideIn 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 80px;
        }

        .date {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--stone);
            margin-bottom: 16px;
            font-weight: 400;
        }

        .app-title {
            font-family: 'Crimson Pro', serif;
            font-size: 32px;
            font-weight: 300;
            letter-spacing: 3px;
            color: var(--soft-black);
            position: relative;
            padding-bottom: 24px;
        }

        .app-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 1px;
            background: var(--accent);
        }

        /* Decorative corner elements */
        .corner-decoration {
            position: fixed;
            pointer-events: none;
            opacity: 0.25;
            z-index: 1;
        }

        .corner-decoration.top-left {
            top: 0;
            left: 0;
            width: 240px;
            height: 240px;
        }

        .corner-decoration.bottom-right {
            bottom: 0;
            right: 0;
            width: 240px;
            height: 240px;
            transform: rotate(180deg);
        }

        /* Botanical accent for passage container */
        .botanical-accent {
            position: absolute;
            top: -30px;
            right: -15px;
            opacity: 0.15;
            width: 160px;
            height: 160px;
        }

        .passage-container {
            background: white;
            padding: 72px 56px;
            margin-bottom: 48px;
            border: 1px solid var(--whisper);
            position: relative;
        }

        .passage-container::before {
            content: '"';
            position: absolute;
            top: -20px;
            left: 20px;
            font-family: 'Crimson Pro', serif;
            font-size: 120px;
            color: var(--whisper);
            line-height: 1;
            z-index: 0;
        }

        .passage {
            font-family: 'Crimson Pro', serif;
            font-size: 22px;
            line-height: 1.8;
            color: var(--charcoal);
            margin-bottom: 32px;
            font-weight: 400;
            position: relative;
            z-index: 1;
        }

        .attribution {
            text-align: right;
            font-size: 14px;
            color: var(--stone);
            font-style: italic;
            letter-spacing: 0.5px;
        }

        .divider {
            width: 60px;
            height: 1px;
            background: var(--accent);
            margin: 64px auto;
        }

        .reflection-section {
            background: white;
            padding: 56px;
            border: 1px solid var(--whisper);
        }

        .reflection-intro {
            font-size: 13px;
            line-height: 1.9;
            color: var(--charcoal);
            margin-bottom: 48px;
        }

        .reflection-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--stone);
            margin-bottom: 20px;
            font-weight: 400;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 24px;
            border: 1px solid var(--whisper);
            background: var(--cream);
            font-family: 'Work Sans', sans-serif;
            font-size: 15px;
            line-height: 1.8;
            color: var(--charcoal);
            resize: vertical;
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
        }

        textarea::placeholder {
            color: var(--stone);
            opacity: 0.6;
        }

        .save-btn {
            margin-top: 24px;
            padding: 16px 48px;
            width: auto;
        }

        /* Logout button */
        .logout-btn {
            position: fixed;
            top: 24px;
            right: 24px;
            background: transparent;
            border: 1px solid var(--whisper);
            color: var(--stone);
            padding: 10px 20px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .logout-btn:hover {
            border-color: var(--charcoal);
            color: var(--charcoal);
            background: white;
        }

        .settings-btn {
            position: fixed;
            top: 24px;
            right: 120px;
            background: transparent;
            border: 1px solid var(--whisper);
            color: var(--stone);
            padding: 10px 20px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .settings-btn:hover {
            border-color: var(--charcoal);
            color: var(--charcoal);
            background: white;
        }

        /* Streak Counter */
        .streak-counter {
            position: fixed;
            top: 24px;
            left: 24px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            border: 1px solid var(--whisper);
            padding: 10px 16px;
            font-size: 13px;
            color: var(--charcoal);
            z-index: 100;
        }

        .streak-icon {
            font-size: 16px;
        }

        /* Settings Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--cream);
            width: 90%;
            max-width: 500px;
            padding: 48px;
            border: 1px solid var(--whisper);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            position: relative;
        }

        .modal-title {
            font-family: 'Crimson Pro', serif;
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 32px;
            color: var(--soft-black);
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--stone);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .close-modal:hover {
            color: var(--charcoal);
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--stone);
            margin-bottom: 16px;
        }

        .current-email {
            font-size: 14px;
            color: var(--charcoal);
            margin-bottom: 12px;
            padding: 12px;
            background: white;
            border: 1px solid var(--whisper);
        }

        .settings-btn-group {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .small-btn {
            padding: 10px 20px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border: 1px solid var(--charcoal);
            background: transparent;
            color: var(--charcoal);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .small-btn:hover {
            background: var(--charcoal);
            color: var(--cream);
        }

        .small-btn.primary {
            background: var(--soft-black);
            color: var(--cream);
        }

        .small-btn.primary:hover {
            background: var(--charcoal);
        }

        /* Password toggle */
        .password-wrapper {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 0;
            top: 16px;
            background: none;
            border: none;
            color: var(--stone);
            cursor: pointer;
            font-size: 12px;
            padding: 0 4px;
        }

        .password-toggle:hover {
            color: var(--charcoal);
        }

        /* Install App Button */
        .install-btn {
            position: fixed;
            bottom: 32px;
            right: 32px;
            background: var(--soft-black);
            border: 1px solid var(--charcoal);
            color: var(--cream);
            padding: 16px 32px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: block;
            z-index: 1000;
        }

        .install-btn:hover {
            background: var(--charcoal);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .install-btn.show {
            display: block;
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Day Navigation Buttons (Testing Only) */
        .day-nav {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
            display: flex;
            gap: 12px;
        }

        .day-nav.left {
            left: 20px;
        }

        .day-nav.right {
            right: 20px;
        }

        .day-nav-btn {
            background: rgba(250, 247, 242, 0.9);
            border: 1px solid var(--whisper);
            color: var(--charcoal);
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-family: 'Work Sans', sans-serif;
            font-weight: 400;
        }

        .day-nav-btn:hover:not(:disabled) {
            background: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .day-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 24px;
            }

            .login-container {
                padding: 48px 32px;
            }

            .passage-container {
                padding: 48px 32px;
            }

            .passage-container::before {
                top: -25px;
                left: 10px;
                font-size: 100px;
                opacity: 0.4;
            }

            .reflection-section {
                padding: 40px 28px;
            }

            .passage {
                font-size: 19px;
            }

            .app-page {
                padding: 60px 0 80px;
            }

            .logout-btn {
                top: 20px;
                right: 20px;
            }

            .install-btn {
                bottom: 20px;
                right: 20px;
                left: 20px;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Decorative corner elements -->
    <svg class="corner-decoration top-left" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <path d="M0,0 L0,100 Q50,80 100,100 L100,0 Z" fill="#8B8680" opacity="0.3"/>
        <path d="M0,0 L100,0 Q80,50 100,100 L0,100 Z" fill="#8B8680" opacity="0.2"/>
        <circle cx="100" cy="100" r="3" fill="#9C8B7A"/>
    </svg>
    
    <svg class="corner-decoration bottom-right" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <path d="M0,0 L0,100 Q50,80 100,100 L100,0 Z" fill="#8B8680" opacity="0.3"/>
        <path d="M0,0 L100,0 Q80,50 100,100 L0,100 Z" fill="#8B8680" opacity="0.2"/>
        <circle cx="100" cy="100" r="3" fill="#9C8B7A"/>
    </svg>

    <!-- Login Page -->
    <div class="login-page" id="loginPage">
        <button class="install-btn" id="installBtnLogin" style="position: fixed;">Install App</button>
        <div class="login-container">
            <div class="logo">BETWEEN LINES</div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="password" placeholder="********" required>
                        <button type="button" class="password-toggle" id="togglePassword">show</button>
                    </div>
                </div>
                <button type="submit" class="btn" id="loginBtn">Enter</button>
                <div id="errorMessage" style="margin-top: 16px; color: #d32f2f; font-size: 12px; text-align: center;"></div>
                <div style="text-align: center; margin-top: 20px; display: flex; flex-direction: column; gap: 12px;">
                    <a href="#" id="forgotPasswordLink" style="font-size: 11px; color: var(--stone); text-decoration: none; letter-spacing: 1px; text-transform: uppercase;">Forgot Password?</a>
                    <div style="font-size: 11px; color: var(--stone);">
                        <span>Don't have an account?</span>
                        <a href="#" id="goToSignupLink" style="color: var(--charcoal); text-decoration: none; margin-left: 6px; font-weight: 500;">Sign Up</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Signup Page -->
    <div class="login-page" id="signupPage" style="display: none;">
        <button class="install-btn" id="installBtnSignup" style="position: fixed;">Install App</button>
        <div class="login-container">
            <div class="logo">BETWEEN LINES</div>
            <form id="signupForm">
                <div class="form-group">
                    <label for="signupEmail">Email</label>
                    <input type="email" id="signupEmail" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="signupPassword" placeholder="Minimum 6 characters" required>
                        <button type="button" class="password-toggle" id="toggleSignupPassword">show</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="signupPasswordConfirm">Confirm Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="signupPasswordConfirm" placeholder="Re-enter password" required>
                        <button type="button" class="password-toggle" id="toggleSignupPasswordConfirm">show</button>
                    </div>
                </div>
                <button type="submit" class="btn" id="signupBtn">Create Account</button>
                <div id="signupErrorMessage" style="margin-top: 16px; color: #d32f2f; font-size: 12px; text-align: center;"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <div style="font-size: 11px; color: var(--stone);">
                        <span>Already have an account?</span>
                        <a href="#" id="goToLoginLink" style="color: var(--charcoal); text-decoration: none; margin-left: 6px; font-weight: 500;">Log In</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App Page -->
    <div class="app-page" id="appPage">
        <div class="streak-counter" id="streakCounter">
            <span class="streak-icon">Current Streak:</span>
            <span id="streakNumber">0</span>
        </div>
        <button class="settings-btn" id="settingsBtn">Settings</button>
        <button class="logout-btn" id="logoutBtn">Sign Out</button>
        <button class="install-btn" id="installBtn">Install App</button>
        
        <!-- Day Navigation (Testing Only - Remove before public launch) -->
        <div class="day-nav left">
            <button class="day-nav-btn" id="prevDayBtn">&larr; Previous</button>
        </div>
        <div class="day-nav right">
            <button class="day-nav-btn" id="nextDayBtn">Next &rarr;</button>
        </div>
        
        <div class="container">
            <div class="header">
                <div class="date" id="dayNumber"></div>
                <h1 class="app-title">BETWEEN LINES</h1>
                <div class="date" id="currentDate" style="margin-top: 12px; opacity: 0.7;"></div>
            </div>

            <div class="passage-container">
                <svg class="botanical-accent" viewBox="0 0 160 160" xmlns="http://www.w3.org/2000/svg">
                    <!-- Minimalist branch with leaves -->
                    <path d="M80,10 Q70,50 60,90 Q50,120 40,150" 
                          stroke="#8B8680" 
                          stroke-width="2" 
                          fill="none" 
                          opacity="0.5"/>
                    <ellipse cx="55" cy="60" rx="14" ry="7" fill="#9C8B7A" opacity="0.4" transform="rotate(-30 55 60)"/>
                    <ellipse cx="48" cy="95" rx="12" ry="6" fill="#9C8B7A" opacity="0.4" transform="rotate(-45 48 95)"/>
                    <ellipse cx="43" cy="125" rx="13" ry="7" fill="#9C8B7A" opacity="0.4" transform="rotate(-20 43 125)"/>
                    <path d="M80,10 Q90,50 100,90 Q110,120 120,150" 
                          stroke="#8B8680" 
                          stroke-width="2" 
                          fill="none" 
                          opacity="0.5"/>
                    <ellipse cx="105" cy="60" rx="14" ry="7" fill="#9C8B7A" opacity="0.4" transform="rotate(30 105 60)"/>
                    <ellipse cx="112" cy="95" rx="12" ry="6" fill="#9C8B7A" opacity="0.4" transform="rotate(45 112 95)"/>
                    <ellipse cx="117" cy="125" rx="13" ry="7" fill="#9C8B7A" opacity="0.4" transform="rotate(20 117 125)"/>
                </svg>
                <p class="passage" id="passageText">
                </p>
                <p class="attribution" id="passageAttribution"></p>
            </div>

            <div class="divider"></div>

            <div class="reflection-section">
                <div class="reflection-intro" id="reflectionIntro">
                </div>

                <div class="reflection-label">Your reflection on this piece:</div>
                <textarea id="userReflection" placeholder="What does this passage bring up for you?"></textarea>
                <button class="btn save-btn" id="saveBtn">Save Reflection</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <button class="close-modal" id="closeModal">Ã-</button>
            <h2 class="modal-title">Settings</h2>
            
            <div class="settings-section">
                <div class="settings-section-title">Email Address</div>
                <div class="current-email" id="currentEmail"></div>
                <div class="form-group">
                    <label for="newEmail">New Email</label>
                    <input type="email" id="newEmail" placeholder="new@email.com">
                </div>
                <div class="settings-btn-group">
                    <button class="small-btn primary" id="updateEmailBtn">Update Email</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">Password</div>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <input type="password" id="newPassword" placeholder="Minimum 6 characters">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Re-enter password">
                </div>
                <div class="settings-btn-group">
                    <button class="small-btn primary" id="updatePasswordBtn">Update Password</button>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title">Daily Reminder</div>
                <div class="form-group">
                    <label for="notificationTime">Reminder Time</label>
                    <input type="time" id="notificationTime" value="09:00">
                </div>
                <div class="settings-btn-group">
                    <button class="small-btn primary" id="saveNotificationBtn">Save Reminder Time</button>
                </div>
                <p style="font-size: 11px; color: var(--stone); margin-top: 12px;">
                    Note: Daily notifications work best when the app is installed on your device
                </p>
            </div>

            <div id="settingsMessage" style="margin-top: 20px; font-size: 12px; text-align: center;"></div>
        </div>
    </div>

    <!-- Page Navigation Script (non-module, loads immediately) -->
    <script>
        console.log('Navigation script loaded');
        
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ready');
            
            const goToSignupLink = document.getElementById('goToSignupLink');
            const goToLoginLink = document.getElementById('goToLoginLink');
            const loginPage = document.getElementById('loginPage');
            const signupPage = document.getElementById('signupPage');
            
            console.log('goToSignupLink:', goToSignupLink);
            console.log('goToLoginLink:', goToLoginLink);
            
            if (goToSignupLink) {
                goToSignupLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Going to signup page');
                    loginPage.style.display = 'none';
                    signupPage.style.display = 'flex';
                });
            }
            
            if (goToLoginLink) {
                goToLoginLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Going to login page');
                    signupPage.style.display = 'none';
                    loginPage.style.display = 'flex';
                });
            }
            
            // Password visibility toggles
            const togglePassword = document.getElementById('togglePassword');
            const toggleSignupPassword = document.getElementById('toggleSignupPassword');
            const toggleSignupPasswordConfirm = document.getElementById('toggleSignupPasswordConfirm');
            
            if (togglePassword) {
                togglePassword.addEventListener('click', function() {
                    const passwordInput = document.getElementById('password');
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        this.textContent = 'hide';
                    } else {
                        passwordInput.type = 'password';
                        this.textContent = 'show';
                    }
                });
            }
            
            if (toggleSignupPassword) {
                toggleSignupPassword.addEventListener('click', function() {
                    const passwordInput = document.getElementById('signupPassword');
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        this.textContent = 'hide';
                    } else {
                        passwordInput.type = 'password';
                        this.textContent = 'show';
                    }
                });
            }
            
            if (toggleSignupPasswordConfirm) {
                toggleSignupPasswordConfirm.addEventListener('click', function() {
                    const passwordInput = document.getElementById('signupPasswordConfirm');
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        this.textContent = 'hide';
                    } else {
                        passwordInput.type = 'password';
                        this.textContent = 'show';
                    }
                });
            }
        });
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, updateEmail, updatePassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDFhEAdg7noM1f8CrdOi14O6c5f9JsU2gk",
            authDomain: "betweenlines-dbe2b.firebaseapp.com",
            projectId: "betweenlines-dbe2b",
            storageBucket: "betweenlines-dbe2b.firebasestorage.app",
            messagingSenderId: "451292270485",
            appId: "1:451292270485:web:03160fdf9c8f682ff7b09c",
            measurementId: "G-7RV67SWFEJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        console.log('=== FIREBASE INITIALIZATION ===');
        console.log('âœ... Firebase initialized successfully');
        console.log('Auth object:', auth);
        console.log('Auth domain:', auth.config.authDomain);
        console.log('DB object:', db);
        
        // Make auth available globally for debugging
        window.debugAuth = auth;
        window.debugDB = db;

        // CONTENT DATABASE - Add more days here
        const contentDatabase = {
            1: {
                passage: `If at the one moment in your life when the chance of something transcendental is offered to you, if you have this chance to move beyond the surface of things, to understand - and you say, No, maybe not... What then? How do you explain the rest of your life to yourself? How do you pass the time until you die? Do you substitute for that an interest in what - eating? Do you spend the next sixty years trying to be fascinated by the act of breathing?`,
                attribution: "- Sebastian Faulks, Charlotte Gray",
                reflection: `You know what Faulks is really asking here? It's not about missing some grand cosmic opportunity that announces itself with trumpets. It's about that moment - and you've felt it, I've felt it - when something <em>shifts</em>. When you could go deeper with someone. When you could admit what you actually want. When you could step through a door that's quietly open, just for a second.<br><br>And what he's saying is: if you say "maybe not" to that... what do you tell yourself for the rest of your life?<br><br>Because you can't unfeel that moment. You can't unknow that you saw the door. So you end up doing this thing where you try to be <em>very interested</em> in smaller things. You curate restaurants. You have opinions about coffee. You fill the time. And none of it is <em>bad</em>, exactly, but there's this low hum underneath it all - this awareness that you chose the surface when the depth was right there.<br><br>The brutal part is that last line. "Trying to be fascinated by the act of breathing." He's not saying breathing is meaningless - we need to breathe. But if you're <em>trying</em> to find it fascinating, if you're working that hard to convince yourself that the ordinary is enough... then you already know it isn't.<br><br>The thing is, those transcendent moments don't always look transcendent when they arrive. They often look inconvenient. Scary. Badly timed. Easy to postpone.<br><br>And that's what you have to live with - not that you missed something. That you saw it, and said no.`
            },
            2: {
                passage: `Falling in love, we said; I fell for him. We were falling women. We believed in it, this downward motion: so lovely, like flying, and yet at the same time so dire, so extreme, so unlikely. God is love, they once said, but we reversed that, and love, like heaven, was always just around the corner. The more difficult it was to love the particular man beside us, the more we believed in Love, abstract and total. We were waiting, always, for the incarnation. That word, made flesh. And sometimes it happened, for a time. That kind of love comes and goes and is hard to remember afterwards, like pain. You would look at the man one day and you would think, I loved you, and the tense would be past, and you would be filled with a sense of wonder, because it was such an amazing and precarious and dumb thing to have done; and you would know too why your friends had been evasive about it, at the time. There is a good deal of comfort, now, in remembering this.`,
                attribution: "- Margaret Atwood, The Handmaid's Tale",
                reflection: `Atwood takes a cliche, "falling in love," and refuses to let it be too neat.<br><br>She hears the violence inside the phrase. Falling is not choosing. Falling is losing balance. It feels like flight, yes, but it's also gravity, risk, impact. The women in the passage aren't "romantics" in the greeting card sense. They're devotees of the sensation of surrender, and they're honest about how dangerous that devotion is.<br><br>Then she does something sharper: she shows how the idea of Love can become a kind of religion. When the man beside you is ordinary, disappointing, human, you don't just doubt him, you protect the dream by making it more abstract. You believe in "Love" with a capital L precisely because the real person is hard. That's the psychological trick: the harder the particular love, the more you worship the concept. It's a way of staying faithful without having to look too closely.<br><br>That's why "incarnation" matters. It's a religious word meaning the divine becoming flesh. Here it's the fantasy that the perfect Love will finally turn up in a real body, right next to you, and make everything make sense. They're always "waiting... for the incarnation." Not for a relationship, for a revelation.<br><br>And then Atwood twists the knife gently: sometimes it does happen. For a time. Not because fate finally delivered perfection, but because humans can, briefly, make the impossible feel real. That's what makes it so haunting. It's not a lie. It's just not stable.<br><br>The "tense would be past" line is devastatingly plain. One day you look at the person and realise love has become grammar. You loved. Past tense. And the shock isn't only sadness, it's astonishment at yourself. How could you have done something so "precarious and dumb"? Not dumb as in stupid, dumb as in brave-to-the-point-of-self-endangerment.<br><br>The lesson here isn't "don't fall in love." It's more grown-up than that. It's: beware of worshipping an idea so hard that you stop seeing the person. And when love ends, don't rewrite yourself as a fool. Treat it like pain: real when it's happening, strangely hard to remember with accuracy afterwards, and proof that you were alive enough to be hurt.<br><br>That last sentence, "There is a good deal of comfort... in remembering this," is Atwood's quiet mercy. Not comfort in the romance. Comfort in the clear-eyed understanding. In being able to say: I know what I did. I know why. And I survived it.`
            },
            3: {
                passage: `I wanted you to see what real courage is, instead of getting the idea that courage is a man with a gun in his hand. It's when you know you're licked before you begin, but you begin anyway and see it through no matter what.`,
                attribution: "- Harper Lee, To Kill a Mockingbird",
                reflection: `This is Atticus Finch defining courage for his children, and Lee is doing something quietly radical here. She's stripping courage of its theatrics.<br><br>The gun is the obvious symbol. It's what we've been taught to associate with bravery: the quick draw, the showdown, the visible threat met with visible force. That's courage that gets monuments built. But Atticus is saying: no. That's not it.<br><br>Real courage, he says, is knowing the outcome before you start. It's not ignorance or optimism or adrenaline. It's full awareness that you will lose, and choosing to proceed anyway. Not because you think you might win. Because the act itself matters more than the result.<br><br>That phrase "you're licked before you begin" is so plainly honest. No false hope. No "maybe this time will be different." You already know. The verdict is in before the trial starts. The diagnosis won't change. The person won't come back. The system won't bend. You know all this, and you show up anyway.<br><br>Why? Because seeing it through is the point. Not winning. Not even fighting with a chance of victory. Just refusing to let the predetermined loss be the reason you don't try.<br><br>This is the courage of the terminally ill patient who goes to treatment. The whistleblower who knows they'll be destroyed. The parent who keeps showing up for a child who won't speak to them. The artist who finishes the work no one will see. It's not heroic in the cinematic sense. It's often invisible. Quiet. Unglamorous.<br><br>And Lee knows this is a harder courage to teach children because it doesn't come with a clear win. There's no satisfying climax where good triumphs. You do the right thing, and you lose anyway, and you have to find a way to live with that being enough.<br><br>The gun gives you control, or at least the illusion of it. But most of life doesn't give you a gun. It gives you impossible odds and asks: will you try anyway? Not because you're foolish enough to think you'll succeed, but because not trying would mean something worse-living with the knowledge that you chose convenience over conviction.<br><br>That's the courage that costs something. And that's why Atticus needs his children to see it.`
            },
            4: {
                passage: `We cross our bridges when we come to them and burn them behind us, with nothing to show for our progress except a memory of the smell of smoke, and a presumption that once our eyes watered.`,
                attribution: "- Tom Stoppard, Rosencrantz and Guildenstern Are Dead",
                reflection: `Stoppard takes the comforting cliche-"we'll cross that bridge when we come to it"-and shows you what actually happens when you do.<br><br>You cross the bridge. Fine. But then you burn it. Why? Because you can't go back. Whether through choice, consequence, or the simple passage of time, the route you took is now closed. You're committed. The bridge is ash.<br><br>And what do you have to prove you even crossed it? Nothing solid. Just a memory, and even that's unreliable. The "smell of smoke"-already fading, sensory, not factual. And then that devastating phrase: "a presumption that once our eyes watered."<br><br>Not certainty. Presumption. You assume your eyes watered from the smoke, but maybe they didn't. Maybe you've convinced yourself they did because it makes the story coherent. You crossed a bridge, it burned, you were moved by it. Except were you? Or is that just the narrative you've constructed afterward to make sense of a decision that might have been random, impulsive, or forced?<br><br>This is Stoppard doing what he does best: showing how we narrativize our lives into meaning that might not have been there at the time. We burn bridges-cut off people, leave jobs, make irreversible choices-and tell ourselves it was necessary, meaningful, that we felt something profound about it. But in truth? We might just be moving forward because we don't know how to stay still, and then inventing emotional significance afterward to justify the wreckage.<br><br>The "progress" is especially brutal. Progress implies you're going somewhere better, that there's directionality and purpose. But Stoppard puts it in a clause that undercuts itself. What is your progress? A smell. A presumption. Not achievement. Not growth. Just evidence that time passed and you kept moving.<br><br>It's almost a anti-meaning. You do things, they have consequences, you can't undo them, and all you're left with is the story you tell yourself about why you did them. Which might be true. Or might be a story.<br><br>And yet-there's something strangely honest about this view. It doesn't dress up life as a hero's journey. It says: you make choices, or choices are made for you, and either way you can't go back, and you'll spend the rest of your life trying to figure out if it meant anything.`
            },
            5: {
                passage: `The most important things are the hardest to say. They are the things you get ashamed of, because words diminish them-words shrink things that seemed limitless when they were in your head to no more than living size when they're brought out. But it's more than that, isn't it? The most important things lie too close to wherever your secret heart is buried, like landmarks to a treasure your enemies would love to steal away.`,
                attribution: "- Stephen King, The Body",
                reflection: `King is explaining why we stay silent about what matters most, and he's not talking about shyness or articulation problems. He's talking about something more fundamental: the betrayal that happens when you try to share something that lives large inside you.<br><br>Inside your head, an idea, a feeling, a truth can be vast. Limitless. It has dimensions and resonance and a kind of private enormity that sustains you. But the moment you speak it-put it into words, offer it to someone else-it shrinks. Not because you've expressed it badly, but because language itself is reductive. Words can't hold the full size of what you felt. They're living size at best. Human-scale. Manageable. Which means: smaller than what it was.<br><br>That's the shame he's talking about. Not shame that you're inadequate. Shame that the thing itself, once spoken, becomes inadequate. You sound melodramatic, or cliche, or like you're trying too hard. The bigness you felt becomes ordinary once it's outside you. And then you're stuck: defending something that now sounds smaller than you needed it to be.<br><br>But King doesn't stop there. He adds the other reason we keep the most important things to ourselves: protection.<br><br>These truths are "too close to wherever your secret heart is buried." They're not just difficult to express-they're dangerous to reveal. Because they're landmarks. They point to where you're most vulnerable. And if someone wanted to hurt you, really hurt you, that's where they'd aim.<br><br>It's not paranoia. It's survival. You've seen it happen. Someone shares their deepest fear or hope, and later, in an argument or a moment of cruelty, it gets weaponized against them. The thing they trusted you with becomes ammunition. So you learn to be quiet. To keep the most important things vague, protected, unarticulated.<br><br>What King captures here is the loneliness of that. The most important things-by definition the things that matter most to you, that you'd most want to share-are exactly the things you can't share without either diminishing them or risking yourself.<br><br>Which leaves you with what? A secret heart, buried, with landmarks only you can see. Safe. But also alone with it. That's the trade. And King isn't saying whether it's worth it. He's just saying: this is why we do it. This is why the people who know us best often don't know us at all.`
            }
        };

        // Get user's current day (based on signup date, can't skip ahead)
        async function getUserDay(userId) {
            try {
                // Get user data from Firestore
                const userDocRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userDocRef);
                
                let signupDate;
                
                if (!userDoc.exists() || !userDoc.data().signupDate) {
                    // First time - set signup date in Firestore
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // Reset to midnight
                    signupDate = today.toISOString();
                    
                    await setDoc(userDocRef, {
                        signupDate: signupDate,
                        email: auth.currentUser.email
                    }, { merge: true });
                } else {
                    signupDate = userDoc.data().signupDate;
                }
                
                // Calculate days since signup
                const signup = new Date(signupDate);
                signup.setHours(0, 0, 0, 0);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const diffTime = today - signup;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                const currentDay = Math.min(diffDays + 1, Object.keys(contentDatabase).length);
                
                return currentDay;
            } catch (error) {
                console.error('Error getting user day:', error);
                return 1;
            }
        }

        // Calculate streak
        async function calculateStreak(userId) {
            try {
                const reflectionsRef = collection(db, 'users', userId, 'reflections');
                const querySnapshot = await getDocs(reflectionsRef);
                
                if (querySnapshot.empty) {
                    return 0;
                }

                // Get all reflection days and sort them
                const reflectionDays = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.day) {
                        reflectionDays.push(data.day);
                    }
                });
                
                reflectionDays.sort((a, b) => b - a); // Sort descending
                
                if (reflectionDays.length === 0) {
                    return 0;
                }

                // Get current day
                const currentDay = await getUserDay(userId);
                
                // Calculate streak from most recent day backwards
                let streak = 0;
                let expectedDay = currentDay;
                
                for (let day of reflectionDays) {
                    if (day === expectedDay || day === expectedDay - 1) {
                        streak++;
                        expectedDay = day - 1;
                    } else {
                        break;
                    }
                }
                
                return streak;
            } catch (error) {
                console.error('Error calculating streak:', error);
                return 0;
            }
        }

        // Set user's test day (for manual navigation - respects max day limit)
        async function setTestDay(userId, day) {
            const maxDay = await getUserDay(userId);
            const allowedDay = Math.min(day, maxDay);
            localStorage.setItem('test_day_' + userId, allowedDay);
            return allowedDay;
        }

        // Get current viewing day (test mode or actual day)
        async function getCurrentViewingDay(userId) {
            const testDay = localStorage.getItem('test_day_' + userId);
            if (testDay) {
                const maxDay = await getUserDay(userId);
                return Math.min(parseInt(testDay), maxDay);
            }
            return await getUserDay(userId);
        }

        // Load content for current day
        async function loadDayContent(day, maxDay) {
            const content = contentDatabase[day];
            if (content) {
                document.getElementById('dayNumber').textContent = 'Day ' + day;
                document.getElementById('passageText').textContent = content.passage;
                document.getElementById('passageAttribution').textContent = content.attribution;
                document.getElementById('reflectionIntro').innerHTML = content.reflection;
                
                // Update navigation buttons - can only go back, never forward past maxDay
                const totalDays = Object.keys(contentDatabase).length;
                document.getElementById('prevDayBtn').disabled = day <= 1;
                document.getElementById('nextDayBtn').disabled = day >= maxDay || day >= totalDays;
            }
        }

        // Set current date
        const dateElement = document.getElementById('currentDate');
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateElement.textContent = new Date().toLocaleDateString('en-US', options);

        // Get elements
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const loginPage = document.getElementById('loginPage');
        const signupPage = document.getElementById('signupPage');
        const appPage = document.getElementById('appPage');
        const logoutBtn = document.getElementById('logoutBtn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const errorMessage = document.getElementById('errorMessage');

        // Check if user is already logged in
        onAuthStateChanged(auth, async (user) => {
            console.log('Auth state changed:', user ? 'logged in' : 'logged out');
            
            // Reset button states
            if (loginBtn) {
                loginBtn.textContent = 'Enter';
                loginBtn.disabled = false;
            }
            const signupBtn = document.getElementById('signupBtn');
            if (signupBtn) {
                signupBtn.textContent = 'Create Account';
                signupBtn.disabled = false;
            }
            
            if (user) {
                // User is signed in
                console.log('User email:', user.email);
                loginPage.style.display = 'none';
                appPage.style.display = 'block';
                appPage.classList.add('active');
                
                // Load content for user's current day
                const maxDay = await getUserDay(user.uid);
                const viewingDay = await getCurrentViewingDay(user.uid);
                await loadDayContent(viewingDay, maxDay);
                
                // Calculate and display streak
                const streak = await calculateStreak(user.uid);
                document.getElementById('streakNumber').textContent = streak;
                
                // Load saved reflection for current viewing day from Firestore
                try {
                    const reflectionDoc = await getDoc(doc(db, 'users', user.uid, 'reflections', `day_${viewingDay}`));
                    if (reflectionDoc.exists()) {
                        userReflection.value = reflectionDoc.data().content;
                    } else {
                        userReflection.value = '';
                    }
                } catch (error) {
                    console.error('Error loading reflection:', error);
                    userReflection.value = '';
                }
            } else {
                // User is signed out
                console.log('No user signed in');
                appPage.classList.remove('active');
                appPage.style.display = 'none';
                signupPage.style.display = 'none';
                loginPage.style.display = 'flex';
            }
        });

        // Login functionality
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Login form submitted');
            
            errorMessage.textContent = '';
            loginBtn.textContent = 'Loading...';
            loginBtn.disabled = true;

            const email = emailInput.value;
            const password = passwordInput.value;
            
            console.log('Login attempt with email:', email);

            try {
                console.log('Attempting to sign in...');
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log('Signed in successfully!', userCredential.user);
            } catch (error) {
                console.error('Login error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                loginBtn.textContent = 'Enter';
                loginBtn.disabled = false;
                
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found') {
                    errorMessage.textContent = "Account not found. Click 'Sign Up' below to create an account.";
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage.textContent = 'Incorrect password. Try again or use "Forgot Password"';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage.textContent = 'Please enter a valid email address';
                } else {
                    errorMessage.textContent = 'Error: ' + error.message;
                }
            }
        });

        // Signup functionality
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Signup form submitted');
            
            const signupErrorMessage = document.getElementById('signupErrorMessage');
            const signupBtn = document.getElementById('signupBtn');
            const signupEmail = document.getElementById('signupEmail').value;
            const signupPassword = document.getElementById('signupPassword').value;
            const signupPasswordConfirm = document.getElementById('signupPasswordConfirm').value;
            
            console.log('=== SIGNUP ATTEMPT ===');
            console.log('Email:', signupEmail);
            console.log('Password length:', signupPassword.length);
            console.log('Confirm password length:', signupPasswordConfirm.length);
            console.log('Passwords match:', signupPassword === signupPasswordConfirm);
            console.log('Password:', signupPassword);
            console.log('Confirm:', signupPasswordConfirm);
            
            signupErrorMessage.textContent = '';
            signupBtn.textContent = 'Creating...';
            signupBtn.disabled = true;

            // Validation
            if (signupPassword.length < 6) {
                console.log('âŒ Password too short');
                signupErrorMessage.textContent = 'Password must be at least 6 characters';
                signupBtn.textContent = 'Create Account';
                signupBtn.disabled = false;
                return;
            }

            if (signupPassword !== signupPasswordConfirm) {
                console.log('âŒ Passwords do not match!');
                console.log('Password chars:', signupPassword.split(''));
                console.log('Confirm chars:', signupPasswordConfirm.split(''));
                signupErrorMessage.textContent = 'Passwords do not match';
                signupBtn.textContent = 'Create Account';
                signupBtn.disabled = false;
                return;
            }

            console.log('âœ... Validation passed, attempting Firebase signup...');

            try {
                console.log('Attempting to create account...');
                const userCredential = await createUserWithEmailAndPassword(auth, signupEmail, signupPassword);
                console.log('Account created successfully!', userCredential.user);
                // User will be automatically logged in
            } catch (error) {
                console.error('Signup error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                signupBtn.textContent = 'Create Account';
                signupBtn.disabled = false;
                
                if (error.code === 'auth/email-already-in-use') {
                    signupErrorMessage.textContent = "This email is already registered. Click 'Log In' below.";
                } else if (error.code === 'auth/invalid-email') {
                    signupErrorMessage.textContent = 'Please enter a valid email address';
                } else {
                    signupErrorMessage.textContent = 'Error: ' + error.message;
                }
            }
        });

        // Logout functionality
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                loginForm.reset();
            } catch (error) {
                alert('Error signing out: ' + error.message);
            }
        });

        // Forgot Password functionality
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        forgotPasswordLink.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            
            if (!email) {
                errorMessage.textContent = 'Please enter your email address first';
                return;
            }
            
            try {
                await sendPasswordResetEmail(auth, email);
                errorMessage.style.color = '#2e7d32';
                errorMessage.textContent = 'Password reset email sent! Check your inbox.';
                setTimeout(() => {
                    errorMessage.textContent = '';
                    errorMessage.style.color = '#d32f2f';
                }, 5000);
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    errorMessage.textContent = 'No account found with this email';
                } else {
                    errorMessage.textContent = error.message;
                }
            }
        });

        // Settings Modal
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeModal = document.getElementById('closeModal');
        const currentEmailDisplay = document.getElementById('currentEmail');
        const settingsMessage = document.getElementById('settingsMessage');

        closeModal.addEventListener('click', () => {
            settingsModal.classList.remove('active');
            document.getElementById('newEmail').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            settingsMessage.textContent = '';
        });

        // Click outside modal to close
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                closeModal.click();
            }
        });

        // Update Email
        const updateEmailBtn = document.getElementById('updateEmailBtn');
        updateEmailBtn.addEventListener('click', async () => {
            const newEmail = document.getElementById('newEmail').value;
            const user = auth.currentUser;
            
            if (!newEmail) {
                settingsMessage.style.color = '#d32f2f';
                settingsMessage.textContent = 'Please enter a new email address';
                return;
            }

            if (!newEmail.includes('@')) {
                settingsMessage.style.color = '#d32f2f';
                settingsMessage.textContent = 'Please enter a valid email address';
                return;
            }

            try {
                await updateEmail(user, newEmail);
                settingsMessage.style.color = '#2e7d32';
                settingsMessage.textContent = 'Email updated successfully!';
                currentEmailDisplay.textContent = newEmail;
                document.getElementById('newEmail').value = '';
            } catch (error) {
                if (error.code === 'auth/requires-recent-login') {
                    settingsMessage.style.color = '#d32f2f';
                    settingsMessage.textContent = 'Please log out and log back in before changing your email';
                } else if (error.code === 'auth/email-already-in-use') {
                    settingsMessage.style.color = '#d32f2f';
                    settingsMessage.textContent = 'This email is already in use';
                } else {
                    settingsMessage.style.color = '#d32f2f';
                    settingsMessage.textContent = error.message;
                }
            }
        });

        // Update Password
        const updatePasswordBtn = document.getElementById('updatePasswordBtn');
        updatePasswordBtn.addEventListener('click', async () => {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const user = auth.currentUser;

            if (!newPassword || !confirmPassword) {
                settingsMessage.style.color = '#d32f2f';
                settingsMessage.textContent = 'Please enter and confirm your new password';
                return;
            }

            if (newPassword.length < 6) {
                settingsMessage.style.color = '#d32f2f';
                settingsMessage.textContent = 'Password must be at least 6 characters';
                return;
            }

            if (newPassword !== confirmPassword) {
                settingsMessage.style.color = '#d32f2f';
                settingsMessage.textContent = 'Passwords do not match';
                return;
            }

            try {
                await updatePassword(user, newPassword);
                settingsMessage.style.color = '#2e7d32';
                settingsMessage.textContent = 'Password updated successfully!';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
            } catch (error) {
                if (error.code === 'auth/requires-recent-login') {
                    settingsMessage.style.color = '#d32f2f';
                    settingsMessage.textContent = 'Please log out and log back in before changing your password';
                } else {
                    settingsMessage.style.color = '#d32f2f';
                    settingsMessage.textContent = error.message;
                }
            }
        });

        // Save Notification Time
        const saveNotificationBtn = document.getElementById('saveNotificationBtn');
        const notificationTimeInput = document.getElementById('notificationTime');

        saveNotificationBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            const time = notificationTimeInput.value;
            
            if (!time) {
                settingsMessage.style.color = '#d32f2f';
                settingsMessage.textContent = 'Please select a time';
                return;
            }

            try {
                // Request notification permission if not granted
                if (Notification.permission !== 'granted') {
                    const granted = await requestNotificationPermission();
                    if (!granted) {
                        settingsMessage.style.color = '#d32f2f';
                        settingsMessage.textContent = 'Please enable notifications in your browser settings';
                        return;
                    }
                }

                // Save notification time to Firestore
                await setDoc(doc(db, 'users', user.uid), {
                    notificationTime: time
                }, { merge: true });

                settingsMessage.style.color = '#2e7d32';
                settingsMessage.textContent = `Daily reminder set for ${time}`;
            } catch (error) {
                settingsMessage.style.color = '#d32f2f';
                settingsMessage.textContent = 'Error saving reminder time: ' + error.message;
            }
        });

        // Load notification time when opening settings
        settingsBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user) {
                currentEmailDisplay.textContent = user.email;
                
                // Load saved notification time
                try {
                    const userDoc = await getDoc(doc(db, 'users', user.uid));
                    if (userDoc.exists() && userDoc.data().notificationTime) {
                        notificationTimeInput.value = userDoc.data().notificationTime;
                    }
                } catch (error) {
                    console.error('Error loading notification time:', error);
                }
                
                settingsModal.classList.add('active');
            }
        });

        // Save reflection functionality (now using Firestore)
        const saveBtn = document.getElementById('saveBtn');
        const userReflection = document.getElementById('userReflection');

        saveBtn.addEventListener('click', async () => {
            const reflection = userReflection.value;
            if (reflection.trim()) {
                const user = auth.currentUser;
                if (user) {
                    const viewingDay = await getCurrentViewingDay(user.uid);
                    
                    try {
                        // Save to Firestore
                        await setDoc(doc(db, 'users', user.uid, 'reflections', `day_${viewingDay}`), {
                            content: reflection,
                            day: viewingDay,
                            timestamp: new Date().toISOString()
                        });
                        
                        // Recalculate and update streak
                        const streak = await calculateStreak(user.uid);
                        document.getElementById('streakNumber').textContent = streak;
                        
                        // Visual feedback
                        saveBtn.textContent = 'Saved';
                        saveBtn.style.background = '#9C8B7A';
                        
                        setTimeout(() => {
                            saveBtn.textContent = 'Save Reflection';
                            saveBtn.style.background = '';
                        }, 2000);
                    } catch (error) {
                        console.error('Error saving reflection:', error);
                        alert('Error saving reflection. Please try again.');
                    }
                }
            }
        });

        // Day Navigation Buttons (Testing Only)
        const prevDayBtn = document.getElementById('prevDayBtn');
        const nextDayBtn = document.getElementById('nextDayBtn');

        prevDayBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user) {
                const viewingDay = await getCurrentViewingDay(user.uid);
                const maxDay = await getUserDay(user.uid);
                
                if (viewingDay > 1) {
                    const newDay = viewingDay - 1;
                    await setTestDay(user.uid, newDay);
                    await loadDayContent(newDay, maxDay);
                    
                    // Load saved reflection for this day from Firestore
                    try {
                        const reflectionDoc = await getDoc(doc(db, 'users', user.uid, 'reflections', `day_${newDay}`));
                        if (reflectionDoc.exists()) {
                            userReflection.value = reflectionDoc.data().content;
                        } else {
                            userReflection.value = '';
                        }
                    } catch (error) {
                        console.error('Error loading reflection:', error);
                        userReflection.value = '';
                    }
                }
            }
        });

        nextDayBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user) {
                const viewingDay = await getCurrentViewingDay(user.uid);
                const maxDay = await getUserDay(user.uid);
                const totalDays = Object.keys(contentDatabase).length;
                
                // Can only go forward if not at maxDay yet
                if (viewingDay < maxDay && viewingDay < totalDays) {
                    const newDay = viewingDay + 1;
                    await setTestDay(user.uid, newDay);
                    await loadDayContent(newDay, maxDay);
                    
                    // Load saved reflection for this day from Firestore
                    try {
                        const reflectionDoc = await getDoc(doc(db, 'users', user.uid, 'reflections', `day_${newDay}`));
                        if (reflectionDoc.exists()) {
                            userReflection.value = reflectionDoc.data().content;
                        } else {
                            userReflection.value = '';
                        }
                    } catch (error) {
                        console.error('Error loading reflection:', error);
                        userReflection.value = '';
                    }
                }
            }
        });
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/between-lines/service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');
        const installBtnLogin = document.getElementById('installBtnLogin');
        const installBtnSignup = document.getElementById('installBtnSignup');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent the mini-infobar from appearing on mobile
            e.preventDefault();
            // Save the event so it can be triggered later
            deferredPrompt = e;
            // Buttons are already visible by default
        });

        // Handle all install buttons
        [installBtn, installBtnLogin, installBtnSignup].forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!deferredPrompt) {
                    // If no install prompt available, show instructions
                    if (window.matchMedia('(display-mode: standalone)').matches) {
                        alert('App is already installed!');
                    } else {
                        alert('To install this app:\n\niPhone/iPad: Tap the Share button and select "Add to Home Screen"\n\nAndroid: Tap the menu (⋮) and select "Add to Home screen" or "Install app"');
                    }
                    return;
                }
                // Show the install prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                // Clear the deferredPrompt
                deferredPrompt = null;
                // Hide the install buttons
                installBtn.style.display = 'none';
                installBtnLogin.style.display = 'none';
                installBtnSignup.style.display = 'none';
            });
        });

        // Hide button after successful install
        window.addEventListener('appinstalled', () => {
            installBtn.style.display = 'none';
            installBtnLogin.style.display = 'none';
            installBtnSignup.style.display = 'none';
            console.log('PWA installed successfully');
        });

        // Push Notifications for Daily Reminders
        async function requestNotificationPermission() {
            if ('Notification' in window && 'serviceWorker' in navigator) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Notification permission granted');
                    // Schedule daily notification (you'll need to set this up in settings)
                    return true;
                }
            }
            return false;
        }

    </script>
</body>
</html>
